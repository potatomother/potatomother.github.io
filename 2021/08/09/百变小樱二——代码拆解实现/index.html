

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Yu Li">
  <meta name="keywords" content="">
  
  <title>百变小樱二——代码拆解实现 - Potatomother Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>potatomother(李煜)</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                简历
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="百变小樱二——代码拆解实现">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-09 18:44" pubdate>
        2021年8月9日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      158
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">百变小樱二——代码拆解实现</h1>
            
            <div class="markdown-body">
              <h1 id="百变小樱二——代码拆解实现"><a href="#百变小樱二——代码拆解实现" class="headerlink" title="百变小樱二——代码拆解实现"></a>百变小樱二——代码拆解实现</h1><h4 id="看我！-点我查看项目演示"><a href="#看我！-点我查看项目演示" class="headerlink" title="看我！~点我查看项目演示"></a><a target="_blank" rel="noopener" href="https://potatomother.github.io/MyPage/cardcaptorsakura-gh-pages/">看我！~点我查看项目演示</a></h4><p>先放一张完整的效果图</p>
<p><img src="1.png" srcset="/img/loading.gif" lazyload alt="完整效果图"></p>
<p>接着我们一步一步拆解代码进行实现</p>
<h2 id="1-读入数据"><a href="#1-读入数据" class="headerlink" title="1.读入数据"></a>1.读入数据</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">d3.queue() <span class="hljs-comment">//queue队列  defer任务  await执行完成之后调用函数</span><br>    .defer(d3.json,<span class="hljs-string">&quot;../data/ccs_chapter_hierarchy.json&quot;</span>)<br>    .defer(d3.json, <span class="hljs-string">&quot;../data/ccs_chapter_total.json&quot;</span>)<br>    .defer(d3.json,<span class="hljs-string">&quot;../data/ccs_character_per_chapter.json&quot;</span>)<br>    .defer(d3.json,<span class="hljs-string">&quot;../data/ccs_character_per_chapter_cover.json&quot;</span>)<br>    .defer(d3.csv,<span class="hljs-string">&quot;../data/ccs_character_total.csv&quot;</span>)<br>    .defer(d3.csv,<span class="hljs-string">&quot;../data/ccs_character_relations.csv&quot;</span>)<br>    .defer(d3.json,<span class="hljs-string">&quot;../data/ccs_color_distribution.json&quot;</span>)<br>    .await(draw);  <span class="hljs-comment">//执行完成队列里的任务之后执行draw</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">draw</span>(<span class="hljs-params">error,chapter_hierarchy_data,chapter_total_data,character_data,cover_data,character_total_data,relation_data,color_data</span>)</span>&#123;<br>    <span class="hljs-built_in">console</span>.log(character_total_data);<br>&#125;<span class="hljs-comment">//await 调用的函数draw，第一个返回值应该是error</span><br><br></code></pre></td></tr></table></figure>

<h2 id="2-最内圈的彩色甜甜圈"><a href="#2-最内圈的彩色甜甜圈" class="headerlink" title="2.最内圈的彩色甜甜圈"></a>2.最内圈的彩色甜甜圈</h2><p>先画最内圈的彩色甜甜圈，如下图所示：</p>
<p><img src="2.png" srcset="/img/loading.gif" lazyload alt="image-20210809111332415"></p>
<h3 id="甜甜圈"><a href="#甜甜圈" class="headerlink" title="甜甜圈"></a>甜甜圈</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs javascript">rad_donut_inner = width * <span class="hljs-number">0.122</span>, <span class="hljs-comment">//字符圈的内半径</span><br>      rad_donut_outer = width * <span class="hljs-number">0.13</span>, <span class="hljs-comment">//字符圈的外半径</span><br>      <span class="hljs-comment">//字符圆环图的 Arc 命令</span><br>      <span class="hljs-keyword">var</span> arc = d3.arc() <br>          .outerRadius(rad_donut_outer)<span class="hljs-comment">//外圈大小</span><br>          .innerRadius(rad_donut_inner)<span class="hljs-comment">//内圈大小</span><br>          .padAngle(<span class="hljs-number">0.01</span>) <span class="hljs-comment">//间隔</span><br>          .cornerRadius((rad_donut_outer - rad_donut_inner) / <span class="hljs-number">2</span> * <span class="hljs-number">1</span>)<span class="hljs-comment">//圆角</span><br>      <span class="hljs-comment">//用于计算甜甜圈切片大小的饼图函数</span><br>      <span class="hljs-keyword">var</span> pie = d3.pie()  <br>          .sort(<span class="hljs-literal">null</span>)<br>          .value(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.num_chapters; &#125;);<span class="hljs-comment">//关键字设为角色出现的章节数（num_chapters）</span><br><br>      <span class="hljs-keyword">var</span> arcs = pie(character_total_data);<br>      arcs.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>          d.character = character_total_data[i].character;<br>          d.centerAngle = (d.endAngle - d.startAngle) / <span class="hljs-number">2</span> + d.startAngle;<br>      &#125;);<br><br>      <span class="hljs-comment">//创建每个角色的甜甜圈切片（以及它们出现的章节数）</span><br>      <span class="hljs-keyword">var</span> donut_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;donut-group&quot;</span>);<br>      <span class="hljs-keyword">var</span> slice = donut_group.selectAll(<span class="hljs-string">&quot;.arc&quot;</span>)<br>          .data(arcs)<br>          .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;arc&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;d&quot;</span>, arc)<br>          .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.data.color; &#125;);<br></code></pre></td></tr></table></figure>

<h3 id="名字标签"><a href="#名字标签" class="headerlink" title="名字标签"></a>名字标签</h3><p>然后在这个基础上增加姓名标签，姓名标签分两部分：大写的名字和小写的姓。这里是增加的同学标签</p>
<p><img src="3.png" srcset="/img/loading.gif" lazyload alt="image-20210809115907973"></p>
<p>代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> hover_circle_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;hover-circle-group&quot;</span>);<br><span class="hljs-keyword">var</span> name_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;name-group&quot;</span>);<br><br><span class="hljs-comment">//为每个角色创建一个组</span><br><span class="hljs-keyword">var</span> names = name_group.selectAll(<span class="hljs-string">&quot;.name&quot;</span>)<br>    .data(arcs)<br>    .enter().append(<span class="hljs-string">&quot;g&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>)<br>    .style(<span class="hljs-string">&quot;text-anchor&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.centerAngle &gt; <span class="hljs-number">0</span> &amp; d.centerAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-string">&quot;start&quot;</span> : <span class="hljs-string">&quot;end&quot;</span>;; &#125;)<br>    .style(<span class="hljs-string">&quot;font-family&quot;</span>, <span class="hljs-string">&quot;Anime Ace&quot;</span>)<br><br><span class="hljs-comment">//添加一个大的 &quot;main&quot; 名字</span><br>names.append(<span class="hljs-string">&quot;text&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;name-label&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;name-label-&quot;</span> + i; &#125;)<br>    .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;.35em&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>        <span class="hljs-comment">//If there is a last name, move the first a bit upward</span><br>        <span class="hljs-keyword">if</span>(character_total_data[i].last_name !== <span class="hljs-string">&quot;&quot;</span>) &#123;<br>            <span class="hljs-keyword">var</span> finalAngle = d.centerAngle + (d.centerAngle &gt; <span class="hljs-number">0</span> &amp; d.centerAngle &lt; <span class="hljs-built_in">Math</span>.PI ? -<span class="hljs-number">0.02</span> : <span class="hljs-number">0.02</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">var</span> finalAngle = d.centerAngle;<br>        &#125;<span class="hljs-comment">//else</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + (finalAngle * <span class="hljs-number">180</span> / <span class="hljs-built_in">Math</span>.PI - <span class="hljs-number">90</span>) + <span class="hljs-string">&quot;)&quot;</span><br>            + <span class="hljs-string">&quot;translate(&quot;</span> + rad_name + <span class="hljs-string">&quot;)&quot;</span><br>            + (finalAngle &gt; <span class="hljs-number">0</span> &amp; finalAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;rotate(180)&quot;</span>);<br>    &#125;)<br>    .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">12</span>*size_factor)+<span class="hljs-string">&quot;px&quot;</span>)<br>    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> character_total_data[i].first_name; &#125;);<br><br><span class="hljs-comment">//在后面添加一个小的姓氏</span><br>names.append(<span class="hljs-string">&quot;text&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;last-name-label&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;last-name-label-&quot;</span> + i; &#125;)<br>    .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;.35em&quot;</span>)<br>    .a ttr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>        <span class="hljs-comment">//If there is a last name, move the last a bit downward</span><br>        <span class="hljs-keyword">if</span>(character_total_data[i].last_name !== <span class="hljs-string">&quot;&quot;</span>) &#123;<br>            <span class="hljs-keyword">var</span> finalAngle = d.centerAngle + (d.centerAngle &gt; <span class="hljs-number">0</span> &amp; d.centerAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-number">0.03</span> : -<span class="hljs-number">0.03</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">var</span> finalAngle = d.centerAngle;<br>        &#125;<span class="hljs-comment">//else</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + (finalAngle * <span class="hljs-number">180</span> / <span class="hljs-built_in">Math</span>.PI - <span class="hljs-number">90</span>) + <span class="hljs-string">&quot;)&quot;</span><br>            + <span class="hljs-string">&quot;translate(&quot;</span> + rad_name + <span class="hljs-string">&quot;)&quot;</span><br>            + (finalAngle &gt; <span class="hljs-number">0</span> &amp; finalAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;rotate(180)&quot;</span>);<br>    &#125;)<br>    .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">9</span>*size_factor)+<span class="hljs-string">&quot;px&quot;</span>)<br>    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> character_total_data[i].last_name; &#125;);<br><br><span class="hljs-comment">//增加一行 添加一个classmate</span><br>names.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123; <span class="hljs-keyword">return</span> i === arcs.length - <span class="hljs-number">1</span>; &#125;)<br>    .append(<span class="hljs-string">&quot;text&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;last-name-label&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;.35em&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-string">&quot;1.35em&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> finalAngle = (d.endAngle - d.startAngle) / <span class="hljs-number">2</span> + d.startAngle - <span class="hljs-number">0.03</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + (finalAngle * <span class="hljs-number">180</span> / <span class="hljs-built_in">Math</span>.PI - <span class="hljs-number">90</span>) + <span class="hljs-string">&quot;)&quot;</span><br>            + <span class="hljs-string">&quot;translate(&quot;</span> + rad_name + <span class="hljs-string">&quot;)rotate(180)&quot;</span>;<br>    &#125;)<br>    .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">9</span>*size_factor)+<span class="hljs-string">&quot;px&quot;</span>)<br>    .text(<span class="hljs-string">&quot;Rika, Yamazaki&quot;</span>);<br><br><br></code></pre></td></tr></table></figure>

<h3 id="名字外侧的点"><a href="#名字外侧的点" class="headerlink" title="名字外侧的点"></a>名字外侧的点</h3><p>加上名字后面的点，方便后面做交互：</p>
<p><img src="4.png" srcset="/img/loading.gif" lazyload alt="image-20210809140130447"></p>
<p>代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>      <span class="hljs-comment">///////////////////////////// 创建名字后面的点 ////////////////////////////</span><br>      <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>      <span class="hljs-keyword">var</span> characterByName = [];<br>      <span class="hljs-comment">//名字后面的点的颜色可以是类型</span><br>      character_total_data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>          <span class="hljs-keyword">var</span> text_width_first = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;name-label-&#x27;</span> + i).getComputedTextLength();<br>          <span class="hljs-keyword">var</span> text_width_last = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;last-name-label-&#x27;</span> + i).getComputedTextLength();<br>          d.dot_name_rad = rad_name + <span class="hljs-built_in">Math</span>.max(text_width_first,text_width_last) + <span class="hljs-number">10</span>;<br>          d.name_angle = (arcs[i].endAngle - arcs[i].startAngle) / <span class="hljs-number">2</span> + arcs[i].startAngle;<br><br>          characterByName[d.character] = d;<br>      &#125;)<span class="hljs-comment">//forEach</span><br><br>      <span class="hljs-comment">//在每个字符的每个名称的末尾添加一个圆圈</span><br>      <span class="hljs-keyword">var</span> name_dot_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;name-dot-group&quot;</span>);<br>      <span class="hljs-keyword">var</span> name_dot = name_dot_group.selectAll(<span class="hljs-string">&quot;.type-dot&quot;</span>)<br>          .data(character_total_data)<br>          .enter().append(<span class="hljs-string">&quot;circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;type-dot&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.dot_name_rad * <span class="hljs-built_in">Math</span>.cos(d.name_angle - pi1_2); &#125;)<br>          .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.dot_name_rad * <span class="hljs-built_in">Math</span>.sin(d.name_angle - pi1_2); &#125;)<br>          .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-number">6</span> * size_factor)<br>          .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.color; &#125;)<br>          .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;white&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">3</span> * size_factor);<br></code></pre></td></tr></table></figure>





<h3 id="人物关系线条"><a href="#人物关系线条" class="headerlink" title="人物关系线条"></a>人物关系线条</h3><p>之后是增加甜甜圈内部的关系，线条代表了不同人物之间存在的关系</p>
<p><img src="5.png" srcset="/img/loading.gif" lazyload alt="image-20210809140511572"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>   <span class="hljs-comment">////////////////////////// 创建内部关系 /////////////////////////</span><br>   <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>   <span class="hljs-keyword">var</span> pull_scale = d3.scaleLinear()<br>       .domain([<span class="hljs-number">2</span> * rad_relation, <span class="hljs-number">0</span>])<br>       .range([<span class="hljs-number">0.7</span>, <span class="hljs-number">2.3</span>]);<br>   <span class="hljs-keyword">var</span> color_relation = d3.scaleOrdinal()<br>       .domain([<span class="hljs-string">&quot;family&quot;</span>, <span class="hljs-string">&quot;crush&quot;</span>, <span class="hljs-string">&quot;love&quot;</span>, <span class="hljs-string">&quot;friends&quot;</span>, <span class="hljs-string">&quot;master&quot;</span>]) <span class="hljs-comment">//&quot;teacher&quot;,&quot;ex-lovers&quot;,&quot;reincarnation&quot;,&quot;rival&quot;</span><br>       .range([<span class="hljs-string">&quot;#2C9AC6&quot;</span>, <span class="hljs-string">&quot;#FA88A8&quot;</span>, <span class="hljs-string">&quot;#E01A25&quot;</span>, <span class="hljs-string">&quot;#7EB852&quot;</span>, <span class="hljs-string">&quot;#F6B42B&quot;</span>])<br>       .unknown(<span class="hljs-string">&quot;#bbbbbb&quot;</span>);<br>   <span class="hljs-keyword">var</span> stroke_relation = d3.scaleOrdinal()<br>       .domain([<span class="hljs-string">&quot;family&quot;</span>, <span class="hljs-string">&quot;crush&quot;</span>, <span class="hljs-string">&quot;love&quot;</span>, <span class="hljs-string">&quot;friends&quot;</span>, <span class="hljs-string">&quot;master&quot;</span>]) <span class="hljs-comment">//&quot;teacher&quot;,&quot;ex-lovers&quot;,&quot;reincarnation&quot;,&quot;rival&quot;</span><br>       .range([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>])<br>       .unknown(<span class="hljs-number">3</span>);<br><br>   <span class="hljs-keyword">var</span> relation_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;relation-group&quot;</span>);<br><br>   <span class="hljs-comment">//在具有关系的人物之间创建area</span><br>   <span class="hljs-keyword">var</span> relation_lines = relation_group.selectAll(<span class="hljs-string">&quot;.relation-path&quot;</span>)<br>       .data(relation_data)<br>       .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>       .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;relation-path&quot;</span>)<br>       .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>       .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> color_relation(d.type); &#125;)<br>       .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> stroke_relation(d.type) * size_factor; &#125;)<br>       .style(<span class="hljs-string">&quot;stroke-linecap&quot;</span>, <span class="hljs-string">&quot;round&quot;</span>)<br>       .style(<span class="hljs-string">&quot;mix-blend-mode&quot;</span>, <span class="hljs-string">&quot;multiply&quot;</span>)<br>       .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.7</span>)<br>       .attr(<span class="hljs-string">&quot;d&quot;</span>, create_relation_lines);<br><br>   <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_relation_lines</span>(<span class="hljs-params">d</span>) </span>&#123;<br>       <span class="hljs-keyword">var</span> source_a = characterByName[d.source].name_angle,<br>           target_a = characterByName[d.target].name_angle;<br>       <span class="hljs-keyword">var</span> x1 = rad_relation * <span class="hljs-built_in">Math</span>.cos(source_a - pi1_2),<br>           y1 = rad_relation * <span class="hljs-built_in">Math</span>.sin(source_a - pi1_2),<br>           x2 = rad_relation * <span class="hljs-built_in">Math</span>.cos(target_a - pi1_2),<br>           y2 = rad_relation * <span class="hljs-built_in">Math</span>.sin(target_a - pi1_2);<br>       <span class="hljs-keyword">var</span> dx = x2 - x1,<br>           dy = y2 - y1,<br>           dr = <span class="hljs-built_in">Math</span>.sqrt(dx * dx + dy * dy);<br>       <span class="hljs-keyword">var</span> curve = dr * <span class="hljs-number">1</span> / pull_scale(dr);<br><br>       <span class="hljs-comment">//获得角度来确定最佳扫描标志</span><br>       <span class="hljs-keyword">var</span> delta_angle = (target_a - source_a) / <span class="hljs-built_in">Math</span>.PI;<br>       <span class="hljs-keyword">var</span> sweep_flag = <span class="hljs-number">0</span>;<br>       <span class="hljs-keyword">if</span> ((delta_angle &gt; -<span class="hljs-number">1</span> &amp;&amp; delta_angle &lt;= <span class="hljs-number">0</span>) || (delta_angle &gt; <span class="hljs-number">1</span> &amp;&amp; delta_angle &lt;= <span class="hljs-number">2</span>))<br>           sweep_flag = <span class="hljs-number">1</span>;<br><br>       <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;M&quot;</span> + x1 + <span class="hljs-string">&quot;,&quot;</span> + y1 + <span class="hljs-string">&quot; A&quot;</span> + curve + <span class="hljs-string">&quot;,&quot;</span> + curve + <span class="hljs-string">&quot; 0 0 &quot;</span> + sweep_flag + <span class="hljs-string">&quot; &quot;</span> + x2 + <span class="hljs-string">&quot;,&quot;</span> + y2;<br>   &#125;<span class="hljs-comment">//function create_relation_lines</span><br></code></pre></td></tr></table></figure>



<h2 id="3-章节"><a href="#3-章节" class="headerlink" title="3.章节"></a>3.章节</h2><h3 id="章节编号"><a href="#章节编号" class="headerlink" title="章节编号"></a>章节编号</h3><p><img src="8.png" srcset="/img/loading.gif" lazyload alt="image-20210809171817442"></p>
<p>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////// 创建章节甜甜圈图 //////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br><span class="hljs-comment">//按正确的顺序去创建一个group</span><br><span class="hljs-keyword">var</span> chapter_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-group&quot;</span>);<br><span class="hljs-keyword">var</span> donut_chapter_group = chapter_group.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;donut-chapter-group&quot;</span>);<br><span class="hljs-keyword">var</span> chapter_dot_group = chapter_group.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-dot-group&quot;</span>);<br><span class="hljs-keyword">var</span> donut_chapter_hover_group = chapter_group.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;donut-chapter_hover-group&quot;</span>);<br><span class="hljs-keyword">var</span> chapter_num_group = chapter_group.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-number-group&quot;</span>);<br><br><span class="hljs-comment">//通过arc 命令得到章节号码甜甜圈</span><br><span class="hljs-keyword">var</span> arc_chapter = d3.arc()<br>    .outerRadius(rad_chapter_donut_outer)<br>    .innerRadius(rad_chapter_donut_inner)<br>    .padAngle(<span class="hljs-number">0.01</span>)<br>    .cornerRadius((rad_chapter_donut_outer - rad_chapter_donut_inner) / <span class="hljs-number">2</span>)<br><br><span class="hljs-comment">//创建每个字符的甜甜圈切片（以及它们出现在的章节数）</span><br><span class="hljs-keyword">var</span> chapter_slice = donut_chapter_group.selectAll(<span class="hljs-string">&quot;.arc&quot;</span>)<br>    .data(chapter_location_data)<br>    .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;arc&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;d&quot;</span>, arc_chapter)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;#c4c4c4&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">1</span> * size_factor);<br><span class="hljs-comment">//创建每个字符的甜甜圈切片的遮罩（以及它们出现在的章节数）</span><br><span class="hljs-keyword">var</span> chapter_hover_slice = donut_chapter_hover_group.selectAll(<span class="hljs-string">&quot;.arc&quot;</span>)<br>    .data(chapter_location_data)<br>    .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;arc&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;d&quot;</span>, arc_chapter)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">1.5</span> * size_factor);<br><br><span class="hljs-comment">//T文本位于每个甜甜圈切片的中心</span><br><span class="hljs-keyword">var</span> rad_chapter_donut_half = ((rad_chapter_donut_outer - rad_chapter_donut_inner) / <span class="hljs-number">2</span> + rad_chapter_donut_inner);<br><br><span class="hljs-comment">//添加章节号文本</span><br><span class="hljs-keyword">var</span> chapter_number = chapter_num_group.selectAll(<span class="hljs-string">&quot;.chapter-number&quot;</span>)<br>    .data(chapter_location_data)<br>    .enter().append(<span class="hljs-string">&quot;text&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-number&quot;</span>)<br>    .style(<span class="hljs-string">&quot;text-anchor&quot;</span>, <span class="hljs-string">&quot;middle&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;.35em&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> angle = d.centerAngle * <span class="hljs-number">180</span> / <span class="hljs-built_in">Math</span>.PI - <span class="hljs-number">90</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + angle + <span class="hljs-string">&quot;)translate(&quot;</span> + rad_chapter_donut_half + <span class="hljs-string">&quot;)&quot;</span> +<br>            <span class="hljs-comment">// (d.centerAngle &gt; 0 &amp; d.centerAngle &lt; Math.PI ? &quot;&quot; : &quot;rotate(180)&quot;)</span><br>            <span class="hljs-string">&quot;rotate(&quot;</span> + -angle + <span class="hljs-string">&quot;)&quot;</span>;<br>    &#125;)<br>    .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">9</span>*size_factor) + <span class="hljs-string">&quot;px&quot;</span>)<br>    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>; &#125;);<br><br><span class="hljs-comment">//在每章切片的内部添加一个圆圈</span><br><span class="hljs-keyword">var</span> chapter_dot_rad = <span class="hljs-number">3.5</span> * size_factor;<br><span class="hljs-keyword">var</span> chapter_dot = chapter_dot_group.selectAll(<span class="hljs-string">&quot;.chapter-dot&quot;</span>)<br>    .data(chapter_location_data)<br>    .enter().append(<span class="hljs-string">&quot;circle&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-dot&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> rad_dot_color * <span class="hljs-built_in">Math</span>.cos(d.centerAngle - pi1_2); &#125;)<br>    .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> rad_dot_color * <span class="hljs-built_in">Math</span>.sin(d.centerAngle - pi1_2); &#125;)<br>    .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;#c4c4c4&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;white&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span>);<br><br></code></pre></td></tr></table></figure>



<h3 id="章节点点"><a href="#章节点点" class="headerlink" title="章节点点"></a>章节点点</h3><p><img src="9.png" srcset="/img/loading.gif" lazyload alt="image-20210809172648323"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////// 创建体积虚线 ///////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br><span class="hljs-comment">//按顺序创建group</span><br><span class="hljs-keyword">var</span> donut_volume_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;donut-volume-group&quot;</span>);<br><br><span class="hljs-comment">//创建 arcs 数据</span><br><span class="hljs-keyword">var</span> volume_data = [<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">5</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">10</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">14</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">18</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">19</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">22</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">23</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">26</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">27</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">30</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">31</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">34</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">9</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">35</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">38</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">39</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">42</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">43</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">45</span> &#125;,<br>    &#123; <span class="hljs-attr">volume</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">num_chapters</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">chapter_start</span>: <span class="hljs-number">46</span>, <span class="hljs-attr">chapter_end</span>: <span class="hljs-number">50</span> &#125;<br>];<br>volume_data = volume_data.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.volume &lt;= num_volume; &#125;);<br><span class="hljs-comment">//指出开始和结束的角度</span><br>volume_data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>    d.startAngle = chapter_location_data[d.chapter_start - <span class="hljs-number">1</span>].startAngle,<br>        d.endAngle = chapter_location_data[d.chapter_end - <span class="hljs-number">1</span>].endAngle;<br>    d.centerAngle = (d.endAngle - d.startAngle) / <span class="hljs-number">2</span> + d.startAngle;<br>&#125;);<br><br><span class="hljs-keyword">var</span> volume_slice = donut_volume_group.selectAll(<span class="hljs-string">&quot;.volume-arc&quot;</span>)<br>    .data(volume_data)<br>    .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;volume-arc&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;#c4c4c4&quot;</span>)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123; <span class="hljs-keyword">return</span> d.volume &lt;= <span class="hljs-number">6</span> ? color_kero : color_sakura; &#125;)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">3</span> * size_factor)<br>    .style(<span class="hljs-string">&quot;stroke-dasharray&quot;</span>, <span class="hljs-string">&quot;0,&quot;</span> + (<span class="hljs-number">7</span> * size_factor))<br>    .attr(<span class="hljs-string">&quot;d&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> rad = rad_volume_inner,<br>            xs = rad * <span class="hljs-built_in">Math</span>.cos(d.startAngle - pi1_2),<br>            ys = rad * <span class="hljs-built_in">Math</span>.sin(d.startAngle - pi1_2),<br>            xt = rad * <span class="hljs-built_in">Math</span>.cos(d.endAngle - pi1_2),<br>            yt = rad * <span class="hljs-built_in">Math</span>.sin(d.endAngle - pi1_2)<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;M&quot;</span> + xs + <span class="hljs-string">&quot;,&quot;</span> + ys + <span class="hljs-string">&quot; A&quot;</span> + rad + <span class="hljs-string">&quot;,&quot;</span> + rad + <span class="hljs-string">&quot; 0 0 1 &quot;</span> + xt + <span class="hljs-string">&quot;,&quot;</span> + yt;<br>    &#125;);<br><br><br></code></pre></td></tr></table></figure>





<h2 id="4-人物和章节的关系线"><a href="#4-人物和章节的关系线" class="headerlink" title="4.人物和章节的关系线"></a>4.人物和章节的关系线</h2><h3 id="关系线"><a href="#关系线" class="headerlink" title="关系线"></a>关系线</h3><p><img src="11.png" srcset="/img/loading.gif" lazyload alt="image-20210809180255662"></p>
<p>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">//////////////////// 创建人物和章节之间的关系线 /////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br><span class="hljs-comment">//线函数，使用canvas将线条从人物连接到章节</span><br><span class="hljs-keyword">var</span> line = d3.lineRadial()<br>    .angle(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.angle; &#125;)<br>    .radius(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.radius; &#125;)<br>    .curve(d3.curveBasis)<br>    .context(ctx);<br><br><span class="hljs-comment">//为封面绘制线条</span><br>ctx.globalAlpha = cover_alpha;<br>create_lines(<span class="hljs-string">&quot;character&quot;</span>, cover_data);<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create_lines</span>(<span class="hljs-params">type, data</span>) </span>&#123;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; data.length; i++) &#123;<br>        d = data[i];<br>        <span class="hljs-keyword">var</span> line_data = [];<br><br>        <span class="hljs-keyword">var</span> source_a = characterByName[d.character].name_angle,<br>            source_r = characterByName[d.character].dot_name_rad<br>        <span class="hljs-keyword">var</span> target_a = chapter_location_data[d.chapter - <span class="hljs-number">1</span>].centerAngle,<br>            target_r = rad_dot_color;<br><br>        <span class="hljs-comment">//找出一些变量来决定要创建的路径</span><br>        <span class="hljs-keyword">if</span> (target_a - source_a &lt; -<span class="hljs-built_in">Math</span>.PI) &#123;<br>            <span class="hljs-keyword">var</span> side = <span class="hljs-string">&quot;cw&quot;</span>;<br>            <span class="hljs-keyword">var</span> da = <span class="hljs-number">2</span> + (target_a - source_a) / <span class="hljs-built_in">Math</span>.PI;<br>            <span class="hljs-keyword">var</span> angle_sign = <span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target_a - source_a &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">var</span> side = <span class="hljs-string">&quot;ccw&quot;</span>;<br>            <span class="hljs-keyword">var</span> da = (source_a - target_a) / <span class="hljs-built_in">Math</span>.PI;<br>            <span class="hljs-keyword">var</span> angle_sign = -<span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target_a - source_a &lt; <span class="hljs-built_in">Math</span>.PI) &#123;<br>            <span class="hljs-keyword">var</span> side = <span class="hljs-string">&quot;cw&quot;</span>;<br>            <span class="hljs-keyword">var</span> da = (target_a - source_a) / <span class="hljs-built_in">Math</span>.PI;<br>            <span class="hljs-keyword">var</span> angle_sign = <span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">var</span> side = <span class="hljs-string">&quot;ccw&quot;</span>;<br>            <span class="hljs-keyword">var</span> da = <span class="hljs-number">2</span> - (target_a - source_a) / <span class="hljs-built_in">Math</span>.PI;<br>            <span class="hljs-keyword">var</span> angle_sign = -<span class="hljs-number">1</span>;<br>        &#125;<span class="hljs-comment">//else</span><br>        <span class="hljs-comment">//console.log(side, da, angle_sign);</span><br><br><br>        <span class="hljs-comment">//计算线路中间弧形部分的半径</span><br>        <span class="hljs-keyword">var</span> range = type === <span class="hljs-string">&quot;character&quot;</span> ? [rad_line_max, rad_line_min] : [rad_line_min, rad_line_max];<br>        <span class="hljs-keyword">var</span> scale_rad_curve = d3.scaleLinear()<br>            .domain([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])<br>            .range(range);<br>        <span class="hljs-keyword">var</span> rad_curve_line = scale_rad_curve(da) * width;<br><br>        <span class="hljs-comment">//对曲线上的第一点上进行稍微的偏移</span><br>        <span class="hljs-keyword">var</span> range = type === <span class="hljs-string">&quot;character&quot;</span> ? [<span class="hljs-number">0</span>, <span class="hljs-number">0.07</span>] : [<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>];<br>        <span class="hljs-keyword">var</span> scale_angle_start_offset = d3.scaleLinear()<br>            .domain([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])<br>            .range(range);<br>        <span class="hljs-keyword">var</span> start_angle = source_a + angle_sign * scale_angle_start_offset(da) * <span class="hljs-built_in">Math</span>.PI;<br><br>        <span class="hljs-comment">//对曲线上的最后一个点进行稍微的偏移</span><br>        <span class="hljs-keyword">var</span> range = type === <span class="hljs-string">&quot;character&quot;</span> ? [<span class="hljs-number">0</span>, <span class="hljs-number">0.02</span>] : [<span class="hljs-number">0</span>, <span class="hljs-number">0.07</span>];<br>        <span class="hljs-keyword">var</span> scale_angle_end_offset = d3.scaleLinear()<br>            .domain([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])<br>            .range(range);<br>        <span class="hljs-keyword">var</span> end_angle = target_a - angle_sign * scale_angle_end_offset(da) * <span class="hljs-built_in">Math</span>.PI;<br><br>        <span class="hljs-keyword">if</span> (target_a - source_a &lt; -<span class="hljs-built_in">Math</span>.PI) &#123;<br>            <span class="hljs-keyword">var</span> da_inner = pi2 + (end_angle - start_angle);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target_a - source_a &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">var</span> da_inner = (start_angle - end_angle);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target_a - source_a &lt; <span class="hljs-built_in">Math</span>.PI) &#123;<br>            <span class="hljs-keyword">var</span> da_inner = (end_angle - start_angle);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (target_a - source_a &lt; <span class="hljs-number">2</span> * <span class="hljs-built_in">Math</span>.PI) &#123;<br>            <span class="hljs-keyword">var</span> da_inner = pi2 - (end_angle - start_angle)<br>        &#125;<span class="hljs-comment">//else if</span><br><br>        <span class="hljs-comment">//将第一个点连接到数据</span><br>        line_data.push(&#123;<br>            <span class="hljs-attr">angle</span>: source_a,<br>            <span class="hljs-attr">radius</span>: source_r<br>        &#125;);<br><br>        <span class="hljs-comment">//附加曲线部分的第一点</span><br>        line_data.push(&#123;<br>            <span class="hljs-attr">angle</span>: start_angle,<br>            <span class="hljs-attr">radius</span>: rad_curve_line<br>        &#125;);<br><br>        <span class="hljs-comment">//为曲线线在中间创建点</span><br>        <span class="hljs-keyword">var</span> step = <span class="hljs-number">0.06</span>;<br>        <span class="hljs-keyword">var</span> n = <span class="hljs-built_in">Math</span>.abs(<span class="hljs-built_in">Math</span>.floor(da_inner / step));<br>        <span class="hljs-keyword">var</span> curve_angle = start_angle;<br>        <span class="hljs-keyword">var</span> sign = side === <span class="hljs-string">&quot;cw&quot;</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span>(n &gt;= <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; n; j++) &#123;<br>                curve_angle += (sign * step) % pi2;<br>                line_data.push(&#123;<br>                    <span class="hljs-attr">angle</span>: curve_angle,<br>                    <span class="hljs-attr">radius</span>: rad_curve_line<br>                &#125;);<br>            &#125;<span class="hljs-comment">//for j</span><br>        &#125;<span class="hljs-comment">//if</span><br><br>        <span class="hljs-comment">//附加曲线部分的最后一个点</span><br>        line_data.push(&#123;<br>            <span class="hljs-attr">angle</span>: end_angle,<br>            <span class="hljs-attr">radius</span>: rad_curve_line<br>        &#125;);<br><br>        <span class="hljs-comment">//将最后一个点连接到数据</span><br>        line_data.push(&#123;<br>            <span class="hljs-attr">angle</span>: target_a,<br>            <span class="hljs-attr">radius</span>: target_r<br>        &#125;);<br><br>        <span class="hljs-comment">//画路径</span><br>        ctx.beginPath();<br>        line(line_data);<br>        ctx.strokeStyle = characterByName[d.character].color;<br>        ctx.stroke();<br><br>    &#125;<span class="hljs-comment">//for</span><br><br>    ctx.globalAlpha = <span class="hljs-number">0.7</span>;<br>    ctx.lineWidth = <span class="hljs-number">3</span> * size_factor;<br><br>&#125;<span class="hljs-comment">//function create_lines</span><br></code></pre></td></tr></table></figure>



<h2 id="5-力模拟"><a href="#5-力模拟" class="headerlink" title="5.力模拟"></a>5.力模拟</h2><h3 id="画最外侧的圆圈"><a href="#画最外侧的圆圈" class="headerlink" title="画最外侧的圆圈"></a>画最外侧的圆圈</h3><p><img src="15.png" srcset="/img/loading.gif" lazyload alt="image-20210810103621738"></p>
<p>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////// 数据准备 //////////////////////////</span><br><span class="hljs-comment">/////////////////////////////////////////////////////////////////////////</span><br><br>color_data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d</span>)</span>&#123;<br>    d.cluster =d.chapter -<span class="hljs-number">1</span>;<br>    d.radius=radius_scale(d.percentage);<br><br>    <span class="hljs-comment">//此数据点的重心</span><br>    d.focusX=rad_color*<span class="hljs-built_in">Math</span>.cos(chapter_location_data[d.cluster].centerAngle-pi1_2);<br>    d.focusY=rad_color*<span class="hljs-built_in">Math</span>.sin(chapter_location_data[d.cluster].centerAngle-pi1_2);<br>    <span class="hljs-comment">//添加一点随机性，以免在模拟中出现奇怪的放置行为</span><br>    d.x=d.focusX+random();<br>    d.y=d.focusY+random();<br>&#125;)<span class="hljs-comment">//forEach</span><br><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">/////////////////////////// 创建颜色圈 //////////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">//在章节点点外侧生成彩色圆圈</span><br><span class="hljs-keyword">var</span> color_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;color-group&quot;</span>);<br><span class="hljs-keyword">var</span> color_circle = color_group.selectAll(<span class="hljs-string">&quot;.color-circle&quot;</span>)<br>    .data(color_data)<br>    .enter().append(<span class="hljs-string">&quot;circle&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;color-circle&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.x; &#125;)<br>    .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.y; &#125;)<br>    .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.radius * size_factor; &#125;)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.color; &#125;)<br>    .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.color; &#125;)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">3</span> * size_factor)<br></code></pre></td></tr></table></figure>

<h3 id="力模拟"><a href="#力模拟" class="headerlink" title="力模拟"></a>力模拟</h3><p><img src="16.png" srcset="/img/loading.gif" lazyload alt="image-20210810103024937"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////// 运行力模拟 //////////////////////////</span><br><span class="hljs-comment">/////////////////////////////////////////////////////////////////////////</span><br><br>simulation = d3.forceSimulation(color_data) <br>    .force(<span class="hljs-string">&quot;x&quot;</span>, d3.forceX().x(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.focusX; &#125;).strength(<span class="hljs-number">0.05</span>))<br>    .force(<span class="hljs-string">&quot;y&quot;</span>, d3.forceY().y(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.focusY; &#125;).strength(<span class="hljs-number">0.05</span>))<br>    .force(<span class="hljs-string">&quot;collide&quot;</span>, d3.forceCollide(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> (d.radius * <span class="hljs-number">1</span> + <span class="hljs-number">2.5</span>) * size_factor; &#125;).strength(<span class="hljs-number">0</span>))<br>    .on(<span class="hljs-string">&quot;tick&quot;</span>, tick)<br>    .on(<span class="hljs-string">&quot;end&quot;</span>, simulation_end)<br>    .alphaMin(<span class="hljs-number">.2</span>)<br><span class="hljs-comment">//.stop();</span><br><span class="hljs-comment">//提高碰撞强度以提供平滑过渡</span><br><span class="hljs-keyword">var</span> t = d3.timer(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elapsed</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> dt = elapsed / <span class="hljs-number">3000</span>;<br>    simulation.force(<span class="hljs-string">&quot;collide&quot;</span>).strength(<span class="hljs-built_in">Math</span>.pow(dt, <span class="hljs-number">2</span>) * <span class="hljs-number">0.7</span>);<br>    <span class="hljs-keyword">if</span> (dt &gt;= <span class="hljs-number">1.0</span>) t.stop();<br>&#125;);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tick</span>(<span class="hljs-params">e</span>) </span>&#123;<br>    color_circle<br>        .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.x; &#125;)<br>        .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.y; &#125;)<br>&#125;<span class="hljs-comment">//function tick</span><br><span class="hljs-comment">//simulation结束的时候运行这个函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">simulation_end</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//Create the CMYK halftones</span><br>    color_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;url(#pattern-total-&quot;</span> + i + <span class="hljs-string">&quot;)&quot;</span>; &#125;)<br>&#125;<span class="hljs-comment">//function simulation_end</span><br>data_save = color_data; <span class="hljs-comment">//存下最终位置</span><br></code></pre></td></tr></table></figure>

<h3 id="绘制CMYK风格的点阵填充"><a href="#绘制CMYK风格的点阵填充" class="headerlink" title="绘制CMYK风格的点阵填充"></a>绘制CMYK风格的点阵填充</h3><p><img src="17.png" srcset="/img/loading.gif" lazyload alt="image-20210810103929090"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br> <span class="hljs-comment">///////////////////// 创建 CMYK 模式 ///////////////////</span><br> <span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br><br> <span class="hljs-comment">//模式基于 http://blockbuilder.org/veltman/50a350e86de82278ffb2df248499d3e2</span><br> <span class="hljs-keyword">var</span> radius_color_max = <span class="hljs-number">2</span> * size_factor;<br> <span class="hljs-keyword">var</span> radius_color = d3.scaleSqrt().range([<span class="hljs-number">0</span>, radius_color_max]);<br><br> <span class="hljs-keyword">var</span> ccs_colors = color_data.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.color; &#125;),<br>     cmyk_colors = [<span class="hljs-string">&quot;yellow&quot;</span>, <span class="hljs-string">&quot;magenta&quot;</span>, <span class="hljs-string">&quot;cyan&quot;</span>, <span class="hljs-string">&quot;black&quot;</span>],<br>     rotation = [<span class="hljs-number">0</span>, -<span class="hljs-number">15</span>, <span class="hljs-number">15</span>, <span class="hljs-number">45</span>];<br> <span class="hljs-built_in">console</span>.log(color_data)<br> <span class="hljs-comment">//循环遍历调色板中的不同颜色</span><br> <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; ccs_colors.length; j++) &#123;<br>     <span class="hljs-comment">//获取此颜色的半径转换</span><br>     <span class="hljs-keyword">var</span> CMYK = rgbToCMYK(d3.rgb(ccs_colors[j]));<br><br>     <span class="hljs-comment">//创建四个模式, C-Y-M-K, 一起形成颜色</span><br>     defs.selectAll(<span class="hljs-string">&quot;.pattern-sub&quot;</span>)<br>         .data(cmyk_colors)<br>         .enter().append(<span class="hljs-string">&quot;pattern&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-built_in">console</span>.log(d);<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pattern-sub-&quot;</span> + d + <span class="hljs-string">&quot;-&quot;</span> + j; &#125;)<br>         .attr(<span class="hljs-string">&quot;patternUnits&quot;</span>, <span class="hljs-string">&quot;userSpaceOnUse&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;patternTransform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + rotation[i] + <span class="hljs-string">&quot;)&quot;</span>; &#125;)<br>         .attr(<span class="hljs-string">&quot;width&quot;</span>, <span class="hljs-number">2</span> * radius_color_max)<br>         .attr(<span class="hljs-string">&quot;height&quot;</span>, <span class="hljs-number">2</span> * radius_color_max)<br>         .append(<span class="hljs-string">&quot;circle&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-built_in">Object</span>)<br>         .attr(<span class="hljs-string">&quot;cx&quot;</span>, radius_color_max)<br>         .attr(<span class="hljs-string">&quot;cy&quot;</span>, radius_color_max)<br>         .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0.001</span>, radius_color(CMYK[d])); &#125;);<br><br>     <span class="hljs-comment">//将 CMYK 模式嵌入更大的图案中</span><br>     <span class="hljs-keyword">var</span> patterns = defs.append(<span class="hljs-string">&quot;pattern&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;pattern-total-&quot;</span> + j)<br>         .attr(<span class="hljs-string">&quot;patternUnits&quot;</span>, <span class="hljs-string">&quot;userSpaceOnUse&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;width&quot;</span>, radius_color_max * <span class="hljs-number">31</span>)<br>         .attr(<span class="hljs-string">&quot;height&quot;</span>, radius_color_max * <span class="hljs-number">31</span>)<br><br>     <span class="hljs-comment">//附上白色背景</span><br>     patterns.append(<span class="hljs-string">&quot;rect&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;width&quot;</span>, width)<br>         .attr(<span class="hljs-string">&quot;height&quot;</span>, height)<br>         .attr(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">0</span>)<br>         .attr(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-number">0</span>)<br>         .style(<span class="hljs-string">&quot;fill&quot;</span>,<span class="hljs-string">&quot;white&quot;</span>)<br><br>     <span class="hljs-comment">//添加CMYK模式</span><br>     patterns<br>         .selectAll(<span class="hljs-string">&quot;.dots&quot;</span>)<br>         .data(cmyk_colors)<br>         .enter().append(<span class="hljs-string">&quot;rect&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;dots&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;width&quot;</span>, width)<br>         .attr(<span class="hljs-string">&quot;height&quot;</span>, height)<br>         .attr(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-number">0</span>)<br>         .attr(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-number">0</span>)<br>         .style(<span class="hljs-string">&quot;mix-blend-mode&quot;</span>, <span class="hljs-string">&quot;multiply&quot;</span>)<br>         .attr(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;url(#pattern-sub-&quot;</span> + cmyk_colors[i] + <span class="hljs-string">&quot;-&quot;</span> + j + <span class="hljs-string">&quot;)&quot;</span>; &#125;)<br> &#125;<span class="hljs-comment">//for j</span><br></code></pre></td></tr></table></figure>

<h2 id="6-加入交互"><a href="#6-加入交互" class="headerlink" title="6.加入交互"></a>6.加入交互</h2><h3 id="线条悬停交互"><a href="#线条悬停交互" class="headerlink" title="线条悬停交互"></a>线条悬停交互</h3><p>最内圈人物与人物之间的关系线条增加交互</p>
<p><code>&quot;mouseover&quot;, mouse_over_relation</code>鼠标移入：鼠标放在某一条弧线上 1.其他的弧线的透明度调低。2.增加文字说明。</p>
<p><code>&quot;mouseout&quot;, mouse_out</code>鼠标移出：1.透明度还原 2. 删除文字说明。</p>
<p>需要强调的一点是，交互是加在一个颜色为白色的遮罩上。重点关注遮罩的宽度，即触发交互的宽度：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//原本的线条宽度</span><br>.style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> stroke_relation(d.type) * size_factor; &#125;)<br><span class="hljs-comment">//遮罩的线条宽度</span><br>.style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">16</span> * size_factor)<br></code></pre></td></tr></table></figure>

<p>效果图：</p>
<p><img src="6.png" srcset="/img/loading.gif" lazyload alt="image-20210809154001171"></p>
<p>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs js">      <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>      <span class="hljs-comment">/////////////////////创建内部关系悬停区域 ////////////////////////////////////</span><br>      <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>      <span class="hljs-keyword">var</span> relation_hover_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;relation-hover-group&quot;</span>);<br>      <span class="hljs-keyword">var</span> relation_hover_lines = relation_hover_group.selectAll(<span class="hljs-string">&quot;.relation-hover-path&quot;</span>)<br>          .data(relation_data)<br>          .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;relation-hover-path&quot;</span>)<br>          .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;white&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">16</span> * size_factor)<br>          .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>)<br>          <span class="hljs-comment">// .style(&quot;pointer-events&quot;, &quot;all&quot;)</span><br>          .attr(<span class="hljs-string">&quot;d&quot;</span>, create_relation_lines)<br>          .on(<span class="hljs-string">&quot;mouseover&quot;</span>, mouse_over_relation)<br>          <span class="hljs-comment">// .on(&quot;mouseout&quot;, mouse_out)</span><br><br>      <span class="hljs-comment">//调用并创建注释的文本部分</span><br>      <span class="hljs-keyword">var</span> annotation_relation_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;annotation-relation-group&quot;</span>);<br><br><span class="hljs-comment">//鼠标移入函数</span><br>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_over_relation</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>          d3.event.stopPropagation();<br>          mouse_over_in_action = <span class="hljs-literal">true</span>;<br><br>          <span class="hljs-built_in">clearTimeout</span>(remove_text_timer);<br><br>          <span class="hljs-comment">//1.只显示鼠标悬停的关系</span><br>          relation_lines.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c,j</span>) </span>&#123; <span class="hljs-keyword">return</span> j !== i; &#125;)<br>              .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.05</span>);<br><br>          <span class="hljs-comment">//2.设置注释</span><br>          <span class="hljs-keyword">var</span> annotations_relationship = [<br>              &#123;<br>                  <span class="hljs-attr">note</span>: &#123;<br>                      <span class="hljs-attr">label</span>: d.note,<br>                      <span class="hljs-attr">title</span>: capitalizeFirstLetter(d.type),<br>                      <span class="hljs-attr">wrap</span>: <span class="hljs-number">150</span>*size_factor,<br>                  &#125;,<br>                  <span class="hljs-attr">relation_type</span>: <span class="hljs-string">&quot;family&quot;</span>,<br>                  <span class="hljs-attr">x</span>: +d.x * size_factor,<br>                  <span class="hljs-attr">y</span>: +d.y * size_factor,<br>                  <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>                  <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>              &#125;<br>          ];<br>          <br>          <span class="hljs-keyword">var</span> makeAnnotationsRelationship = d3.annotation()<br>              <span class="hljs-comment">// .editMode(true)</span><br>              .type(d3.annotationLabel)<br>              .annotations(annotations_relationship);<br>          annotation_relation_group.call(makeAnnotationsRelationship);<br><br>          <span class="hljs-comment">//更新样式</span><br>          annotation_relation_group.selectAll(<span class="hljs-string">&quot;.note-line, .connector&quot;</span>)<br>              .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>          annotation_relation_group.select(<span class="hljs-string">&quot;.annotation-note-title&quot;</span>)<br>              .style(<span class="hljs-string">&quot;fill&quot;</span>, color_relation(d.type) === <span class="hljs-string">&quot;#bbbbbb&quot;</span> ? <span class="hljs-string">&quot;#9e9e9e&quot;</span> : color_relation(d.type));<br><br>      &#125;<span class="hljs-comment">//function mouse_over_relation</span><br><br><br></code></pre></td></tr></table></figure>

<h4 id="鼠标移出"><a href="#鼠标移出" class="headerlink" title="鼠标移出"></a><strong>鼠标移出</strong></h4><p><code>mouse_out</code>事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//鼠标移出函数</span><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_out</span>(<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-comment">//只有当之前有鼠标移入之后的移出时，才会运行此功能</span><br>          <span class="hljs-keyword">if</span>(!mouse_over_in_action) <span class="hljs-keyword">return</span>;<br>          mouse_over_in_action = <span class="hljs-literal">false</span>;<br>        		<span class="hljs-comment">//1.还原所有的关系</span><br>          relation_lines.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.7</span>);<br>            <span class="hljs-comment">//2.移除所有的注释</span><br>          annotation_relation_group.selectAll(<span class="hljs-string">&quot;.annotation&quot;</span>).remove();<br><br>      &#125;<span class="hljs-comment">//function mouse_out</span><br><br></code></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="人物标签"><a href="#人物标签" class="headerlink" title="人物标签"></a>人物标签</h3><h4 id="内小圈：人物标签与内环"><a href="#内小圈：人物标签与内环" class="headerlink" title="内小圈：人物标签与内环"></a>内小圈：人物标签与内环</h4><p>效果：</p>
<p><img src="7.png" srcset="/img/loading.gif" lazyload alt="image-20210809164829671"></p>
<p>分析交互：</p>
<p>鼠标移入名字区域，1.名字外侧的点样式改变 2.显示人物图像</p>
<p>鼠标移出，3.隐藏悬停圆圈，还原点的样式 4.去除人物图像</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs js">		<span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>        <span class="hljs-comment">//////////////////////// 创建遮盖的圈 //////////////////////</span><br>        <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////       </span><br><span class="hljs-comment">//在中心添加一个圆圈，显示悬停上的封面图像</span><br>    <span class="hljs-keyword">var</span> cover_circle_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;cover-circle-group&quot;</span>);<br>    <span class="hljs-keyword">var</span> cover_circle = cover_circle_group.append(<span class="hljs-string">&quot;circle&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;cover-circle&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-number">0</span>)<br>        .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-number">0</span>)<br>        .attr(<span class="hljs-string">&quot;r&quot;</span>, rad_image)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>); <br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>    <span class="hljs-comment">////////////////////// 创建人物名称悬停区域 //////////////////////////////////</span><br>    <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>    <span class="hljs-comment">//创建悬停区域</span><br>    <span class="hljs-keyword">var</span> rad_hover_circle = <span class="hljs-number">35</span> * size_factor;<br>    <span class="hljs-keyword">var</span> hover_circle = hover_circle_group.selectAll(<span class="hljs-string">&quot;.hover-circle&quot;</span>)<br>        .data(character_total_data)<br>        .enter().append(<span class="hljs-string">&quot;circle&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;hover-circle&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.dot_name_rad * <span class="hljs-built_in">Math</span>.cos(d.name_angle - pi1_2); &#125;)<br>        .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.dot_name_rad * <span class="hljs-built_in">Math</span>.sin(d.name_angle - pi1_2); &#125;)<br>        .attr(<span class="hljs-string">&quot;r&quot;</span>, rad_hover_circle)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.color; &#125;)<br>        .style(<span class="hljs-string">&quot;fill-opacity&quot;</span>, <span class="hljs-number">0.3</span>)<br>        .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">var</span> arc_character_hover = d3.arc()<br>        .outerRadius(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123; <span class="hljs-keyword">return</span> character_total_data[i].dot_name_rad + rad_hover_circle; &#125;)<br>        .innerRadius(rad_donut_inner)<br><br>    <span class="hljs-comment">//创建每个字符的甜甜圈切片</span><br>    <span class="hljs-keyword">var</span> character_hover_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;character-hover-group&quot;</span>);<br>    <span class="hljs-keyword">var</span> character_hover = character_hover_group.selectAll(<span class="hljs-string">&quot;.character-hover-arc&quot;</span>)<br>        .data(arcs)<br>        .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;character-hover-arc&quot;</span>)<br>        .attr(<span class="hljs-string">&quot;d&quot;</span>, arc_character_hover)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>        .style(<span class="hljs-string">&quot;pointer-events&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>)<br>        .on(<span class="hljs-string">&quot;mouseover&quot;</span>, mouse_over_character)<br>        .on(<span class="hljs-string">&quot;mouseout&quot;</span>, mouse_out);<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_over_character</span>(<span class="hljs-params">d</span>) </span>&#123;<br>        d3.event.stopPropagation();<br>        mouse_over_in_action = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">//1.显示悬停圈，名字外侧的点样式改变</span><br>        hover_circle.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> d.character === c.character; &#125;)<br>            .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">//2.显示中心中的人物图像</span><br>        cover_image.attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;../img/character-&quot;</span> + d.character.toLowerCase() + <span class="hljs-string">&quot;.jpg&quot;</span>)<br>        cover_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;url(#cover-image)&quot;</span>);<br><br><br><br>    &#125;<span class="hljs-comment">//function mouse_over_character</span><br></code></pre></td></tr></table></figure>

<h5 id="鼠标移出-1"><a href="#鼠标移出-1" class="headerlink" title="鼠标移出"></a><strong>鼠标移出</strong></h5><p><code>mouse_out</code>函数改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//鼠标移出函数</span><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_out</span>(<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-comment">//只有当之前有鼠标移入之后的移出时，才会运行此功能</span><br>          <span class="hljs-keyword">if</span>(!mouse_over_in_action) <span class="hljs-keyword">return</span>;<br>          mouse_over_in_action = <span class="hljs-literal">false</span>;<br>             <span class="hljs-comment">//1.还原所有的关系</span><br>          relation_lines.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.7</span>);<br>            <span class="hljs-comment">//2.移除所有的注释</span><br>          annotation_relation_group.selectAll(<span class="hljs-string">&quot;.annotation&quot;</span>).remove();<br>           <span class="hljs-comment">//3.隐藏悬停圆圈</span><br>          hover_circle.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br>           <span class="hljs-comment">//4.移除中心人物的图像</span><br>          cover_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>          cover_image.attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;../img/white-square.jpg&quot;</span>);<br><br><br>      &#125;<span class="hljs-comment">//function mouse_out</span><br><br></code></pre></td></tr></table></figure>

<h4 id="外大圈：人对章节"><a href="#外大圈：人对章节" class="headerlink" title="外大圈：人对章节"></a>外大圈：人对章节</h4><p><img src="12.png" srcset="/img/loading.gif" lazyload alt="image-20210809181749149"></p>
<p>鼠标悬停在人物上，显示该人物出现在哪些章节。触发的操作：</p>
<p>3.仅显示当前人物与章节的关系线条 4. 对应的章节高亮 </p>
<p>在    <code>mouse_over_character</code>函数中增加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">  <span class="hljs-comment">//3.显示当前人物与章节的关系线条</span><br>ctx.clearRect(-width/<span class="hljs-number">2</span>, -height/<span class="hljs-number">2</span>, width, height);<br>ctx.globalAlpha = <span class="hljs-number">0.8</span>;<br>create_lines(<span class="hljs-string">&quot;character&quot;</span>, character_data.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c,j</span>) </span>&#123;<span class="hljs-keyword">return</span> c.character === d.character; &#125;) );<br><br></code></pre></td></tr></table></figure>

<p><img src="13.png" srcset="/img/loading.gif" lazyload alt="image-20210809182051225"></p>
<p>在    <code>mouse_over_character</code>函数中增加：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//4.突出显示此人物出现的章节</span><br> <span class="hljs-keyword">var</span> char_chapters = character_data<br>     .filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.character === d.character; &#125;)<br>     .map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.chapter; &#125;);<br> <span class="hljs-keyword">var</span> char_color = characterByName[d.character].color;<br> chapter_hover_slice.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c,j</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(j+<span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>; &#125;)<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, char_color)<br>     .style(<span class="hljs-string">&quot;stroke&quot;</span>, char_color);<br> chapter_number.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c,j</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(j+<span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>; &#125;)<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;white&quot;</span>);<br> chapter_dot.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c,j</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(j+<span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>; &#125;)<br>     .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad * <span class="hljs-number">1.5</span>)<br>     .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span> * <span class="hljs-number">1.5</span>)<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, char_color);<br></code></pre></td></tr></table></figure>

<h5 id="鼠标移出-2"><a href="#鼠标移出-2" class="headerlink" title="鼠标移出"></a><strong>鼠标移出</strong></h5><p>需要在<code>mouse_out</code>函数中增加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//5.恢复章节&amp;人物连线</span><br>ctx.clearRect(-width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);<br>ctx.globalAlpha = cover_alpha;<br>create_lines(<span class="hljs-string">&quot;character&quot;</span>, cover_data);<br><br></code></pre></td></tr></table></figure>

<h3 id="章节标签"><a href="#章节标签" class="headerlink" title="章节标签"></a>章节标签</h3><h4 id="章节（除章节对人）"><a href="#章节（除章节对人）" class="headerlink" title="章节（除章节对人）"></a>章节（除章节对人）</h4><p><img src="10.png" srcset="/img/loading.gif" lazyload alt="image-20210809174828999"></p>
<p>鼠标悬停在对应的章节编号上需要触发如下操作：</p>
<p>1.在该章节出现的人物名称亮起，未出现的人物透明度变低2.突出显示章节甜甜圈切片3.在中心显示封面图像</p>
<p>鼠标离开对应的章节编号需要触发如下操作：</p>
<p>6.人物名复原  7.突出显示的章节甜甜圈切片还原 4.移除中心人物的图像</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">/////////////////////创建隐藏章节悬停区域 /////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br><span class="hljs-keyword">var</span> arc_chapter_hover = d3.arc()<br>    .outerRadius(rad_chapter_outer)<br>    .innerRadius(rad_chapter_inner);<br><br><span class="hljs-comment">//每章创建甜甜圈片</span><br><span class="hljs-keyword">var</span> chapter_hover_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-hover-group&quot;</span>);<br><span class="hljs-keyword">var</span> chapter_hover = chapter_hover_group.selectAll(<span class="hljs-string">&quot;.chapter-hover-arc&quot;</span>)<br>    .data(chapter_location_data)<br>    .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;chapter-hover-arc&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;d&quot;</span>, arc_chapter_hover)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>    .style(<span class="hljs-string">&quot;pointer-events&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>)<br>    .on(<span class="hljs-string">&quot;mouseover&quot;</span>, mouse_over_chapter)<br>    .on(<span class="hljs-string">&quot;mouseout&quot;</span>, mouse_out);<br><br><span class="hljs-comment">//当鼠标在章节弧线上</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_over_chapter</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>    d3.event.stopPropagation();<br>    mouse_over_in_action = <span class="hljs-literal">true</span>;<br>    <br>    <span class="hljs-comment">//1.突出显示本章中出现的人物，在该章节出现的人物名称亮起，未出现的人物透明度变低</span><br>    <span class="hljs-keyword">var</span> char_chapters = character_data<br>        .filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.chapter === i+<span class="hljs-number">1</span>; &#125;)<br>        .map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.character; &#125;);<br><br>    names.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(c.character) &lt; <span class="hljs-number">0</span>; &#125;)<br>        .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.2</span>);<br>    name_dot.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(c.character) &lt; <span class="hljs-number">0</span>; &#125;)<br>        .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.2</span>);<br><br>    <span class="hljs-comment">//2.突出显示章节甜甜圈切片</span><br>    chapter_hover_slice.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c, j</span>) </span>&#123; <span class="hljs-keyword">return</span> i === j; &#125;)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, color_sakura)<br>        .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_sakura);<br>    chapter_number.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c, j</span>) </span>&#123; <span class="hljs-keyword">return</span> i === j; &#125;)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;white&quot;</span>);<br>    chapter_dot.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c, j</span>) </span>&#123; <span class="hljs-keyword">return</span> i === j; &#125;)<br>        .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad * <span class="hljs-number">1.5</span>)<br>        .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span> * <span class="hljs-number">1.5</span>)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, color_sakura);<br><br>    <span class="hljs-comment">//3.在中心显示封面图像</span><br>    cover_image.attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;../img/ccs-chapter-&quot;</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">&quot;.jpg&quot;</span>)<br>    cover_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;url(#cover-image)&quot;</span>);<br>&#125;<span class="hljs-comment">//function mouse_over_chapter</span><br></code></pre></td></tr></table></figure>

<h5 id="鼠标移出-3"><a href="#鼠标移出-3" class="headerlink" title="鼠标移出"></a><strong>鼠标移出</strong></h5><p>鼠标移出的情况继续修改<code>mouse_out</code>函数，在之前的基础上增加：6.人物名复原  7.突出显示的章节甜甜圈切片还原</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//6.人物名称恢复正常</span><br>names.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-literal">null</span>);<br>name_dot.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-comment">//7.恢复章节标签</span><br>chapter_hover_slice.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>).style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>chapter_number.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-literal">null</span>);<br>chapter_dot<br>    .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad)<br>    .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span>)<br>    .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;#c4c4c4&quot;</span>);<br></code></pre></td></tr></table></figure>

<h4 id="章节对人"><a href="#章节对人" class="headerlink" title="章节对人"></a>章节对人</h4><p><img src="14.png" srcset="/img/loading.gif" lazyload alt="image-20210809182324048"></p>
<p>鼠标悬停在章节上，显示该章节出现的人物。触发的操作：4.仅显示该章节与人物的连接线 </p>
<p>在    <code> mouse_over_chapter</code>函数中增加：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//4.仅显示该章节与人物的连接线           </span><br>ctx.clearRect(-width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);<br>            ctx.lineWidth = <span class="hljs-number">4</span> * size_factor;<br>            ctx.globalAlpha = <span class="hljs-number">1</span>;<br>            create_lines(<span class="hljs-string">&quot;chapter&quot;</span>, character_data.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.chapter === i+<span class="hljs-number">1</span>; &#125;));<br></code></pre></td></tr></table></figure>

<h5 id="鼠标移出-4"><a href="#鼠标移出-4" class="headerlink" title="鼠标移出"></a><strong>鼠标移出</strong></h5><p>这里<code>mouse_out</code>暂时不需要修改 </p>
<h3 id="力模拟-1"><a href="#力模拟-1" class="headerlink" title="力模拟"></a>力模拟</h3><p>鼠标移入力模拟生成的圆圈区域：1.显示彩色圈圈组的圆环，2.章节编号边框变色 3.突出对应的连线  4.突出对应的人物名称5.在中心显示章节封面图片</p>
<p>鼠标移出力模拟生成的圆圈区域：8.隐藏彩色圈圈组的圆环7.章节编号边框还原 5.连线恢复（章节&amp;人物、人物&amp;人物）  6对应的人物名称恢复4.隐藏中心显示章节封面图片</p>
<p><img src="18.png" srcset="/img/loading.gif" lazyload alt="image-20210810104715343"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br> <span class="hljs-comment">//////////////////////// 创建悬停圆环 ////////////////////////</span><br> <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br> <span class="hljs-comment">//悬停时生成的圆环</span><br> <span class="hljs-keyword">var</span> color_circle_hover_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;color-circle-hover-group&quot;</span>);<br> <span class="hljs-keyword">var</span> color_hover_circle = color_circle_hover_group<br>     <span class="hljs-comment">// .selectAll(&quot;.color-hover-circle&quot;)</span><br>     <span class="hljs-comment">// .data(chapter_location_data)</span><br>     <span class="hljs-comment">// .enter()</span><br>     .append(<span class="hljs-string">&quot;circle&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;color-hover-circle&quot;</span>)<br>     <span class="hljs-comment">// .attr(&quot;cx&quot;, function (d) &#123; return rad_color * Math.cos(d.centerAngle - pi1_2); &#125;)</span><br>     <span class="hljs-comment">// .attr(&quot;cy&quot;, function (d) &#123; return rad_color * Math.sin(d.centerAngle - pi1_2); &#125;)</span><br>     .attr(<span class="hljs-string">&quot;r&quot;</span>,  <span class="hljs-number">36</span> * size_factor)<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>     .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_sakura)<br>     .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span> * <span class="hljs-number">1.5</span>)<br>     .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br><br> <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br> <span class="hljs-comment">////////////////////// 创建隐藏的封面停区域////////////////////</span><br> <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br> <span class="hljs-keyword">var</span> arc_cover_hover = d3.arc()<br>     .outerRadius(rad_cover_outer)<br>     .innerRadius(rad_cover_inner);<br><br> <span class="hljs-comment">//为每章创建甜甜圈片，用于触发交互</span><br> <span class="hljs-keyword">var</span> cover_hover_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;cover-hover-group&quot;</span>);<br> <span class="hljs-keyword">var</span> cover_hover = cover_hover_group.selectAll(<span class="hljs-string">&quot;.cover-hover-arc&quot;</span>)<br>     .data(chapter_location_data)<br>     .enter().append(<span class="hljs-string">&quot;path&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;cover-hover-arc&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;d&quot;</span>, arc_cover_hover)<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>     .style(<span class="hljs-string">&quot;pointer-events&quot;</span>, <span class="hljs-string">&quot;all&quot;</span>)<br>     .on(<span class="hljs-string">&quot;mouseover&quot;</span>, mouse_over_cover)<br>     .on(<span class="hljs-string">&quot;mouseout&quot;</span>, mouse_out);<br><br> <span class="hljs-comment">//当鼠标移入该区域时</span><br> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_over_cover</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>     d3.event.stopPropagation();<br>     mouse_over_in_action = <span class="hljs-literal">true</span>;<br><br>     <span class="hljs-comment">//1.显示彩色圈圈组的圆环</span><br>     color_hover_circle<br>         .attr(<span class="hljs-string">&quot;cx&quot;</span>, rad_color * <span class="hljs-built_in">Math</span>.cos(d.centerAngle - pi1_2))<br>         .attr(<span class="hljs-string">&quot;cy&quot;</span>, rad_color * <span class="hljs-built_in">Math</span>.sin(d.centerAngle - pi1_2))<br>         .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">1</span>);<br><br>     <span class="hljs-comment">//2.章节编号边框变色，突出显示章节甜甜圈切片</span><br>     chapter_hover_slice.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c, j</span>) </span>&#123; <span class="hljs-keyword">return</span> i === j; &#125;)<br>         .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span> * <span class="hljs-number">1.5</span>)<br>         .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_sakura);<br>     chapter_dot.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c, j</span>) </span>&#123; <span class="hljs-keyword">return</span> i === j; &#125;)<br>         .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad * <span class="hljs-number">1.5</span>)<br>         .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span> * <span class="hljs-number">1.5</span>)<br>         .style(<span class="hljs-string">&quot;fill&quot;</span>, color_sakura);<br>     <br>     <span class="hljs-comment">//3.突出对应的连线</span><br>     ctx.clearRect(-width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);<br>     ctx.lineWidth = <span class="hljs-number">4</span> * size_factor;<br>     ctx.globalAlpha = <span class="hljs-number">1</span>;<br>     create_lines(<span class="hljs-string">&quot;character&quot;</span>, cover_data.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.chapter === i+<span class="hljs-number">1</span>; &#125;));<br><br>     <span class="hljs-comment">//4.突出显示本章中出现的人物</span><br>     <span class="hljs-keyword">var</span> char_chapters = cover_data<br>         .filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.chapter === i+<span class="hljs-number">1</span>; &#125;)<br>         .map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> c.character; &#125;);<br><br>     names.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(c.character) &lt; <span class="hljs-number">0</span>; &#125;)<br>         .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.2</span>);<br>     name_dot.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">c</span>) </span>&#123; <span class="hljs-keyword">return</span> char_chapters.indexOf(c.character) &lt; <span class="hljs-number">0</span>; &#125;)<br>         .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.2</span>);<br><br>     <span class="hljs-comment">//5.在中心显示封面图像</span><br>     cover_image.attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;../img/ccs-chapter-&quot;</span> + (i+<span class="hljs-number">1</span>) + <span class="hljs-string">&quot;.jpg&quot;</span>)<br>     cover_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;url(#cover-image)&quot;</span>);<br><br> &#125;<span class="hljs-comment">//function mouse_over_cover</span><br><br></code></pre></td></tr></table></figure>

<h4 id="鼠标移出-5"><a href="#鼠标移出-5" class="headerlink" title="鼠标移出"></a>鼠标移出</h4><p><code>mouse_out</code>增加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//8.隐藏彩色圈圈组的圆环</span><br>color_hover_circle.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br><br></code></pre></td></tr></table></figure>

<h3 id="交互mouse-out总结"><a href="#交互mouse-out总结" class="headerlink" title="交互mouse_out总结"></a>交互mouse_out总结</h3><p>总结所有的移出事件，每次移出调用<code>mouse_out</code>函数，整理的到的函数如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">///////////////////////// 通用的 mouse out 函数 //////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>container.on(<span class="hljs-string">&quot;mouseout&quot;</span>, mouse_out);<br><br><span class="hljs-comment">//当鼠标触发移出事件时的函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mouse_out</span>(<span class="hljs-params"></span>) </span>&#123;            <br>    <span class="hljs-comment">//只有当之前有鼠标移入之后的移出时，才会运行此功能</span><br>    <span class="hljs-keyword">if</span>(!mouse_over_in_action) <span class="hljs-keyword">return</span>;<br>    mouse_over_in_action = <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">//1.还原所有的关系</span><br>    relation_lines.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0.7</span>);<br>    <span class="hljs-comment">//2.移除所有的注释</span><br>    annotation_relation_group.selectAll(<span class="hljs-string">&quot;.annotation&quot;</span>).remove();<br>    <span class="hljs-comment">//3.隐藏悬停圆圈</span><br>    hover_circle.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//4.移除中心人物的图像</span><br>    cover_circle.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>    cover_image.attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;../img/white-square.jpg&quot;</span>);<br>    <span class="hljs-comment">//5.恢复章节&amp;人物连线</span><br>    ctx.clearRect(-width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);<br>    ctx.globalAlpha = cover_alpha;<br>    create_lines(<span class="hljs-string">&quot;character&quot;</span>, cover_data);<br>    <span class="hljs-comment">//6.人物名称恢复正常</span><br>    names.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-literal">null</span>);<br>    name_dot.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">//7.恢复章节标签</span><br>    chapter_hover_slice.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>).style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>    chapter_number.style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-literal">null</span>);<br>    chapter_dot<br>        .attr(<span class="hljs-string">&quot;r&quot;</span>, chapter_dot_rad)<br>        .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, chapter_dot_rad * <span class="hljs-number">0.5</span>)<br>        .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;#c4c4c4&quot;</span>);<br>    <span class="hljs-comment">//8.隐藏彩色圈圈组的圆环</span><br>    color_hover_circle.style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">0</span>);<br>&#125;<span class="hljs-comment">//function mouse_out</span><br></code></pre></td></tr></table></figure>



<h2 id="7-增加注释和一点点细节"><a href="#7-增加注释和一点点细节" class="headerlink" title="7.增加注释和一点点细节"></a>7.增加注释和一点点细节</h2><h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><p><img src="19.png" srcset="/img/loading.gif" lazyload alt="image-20210810113705552"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">//////////////////////// Create captured card labels //////////////////////</span><br><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br><span class="hljs-keyword">var</span> card_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;card-group&quot;</span>);<br><br><span class="hljs-comment">//Create a group per character</span><br><span class="hljs-keyword">var</span> card_label = card_group.selectAll(<span class="hljs-string">&quot;.card-label&quot;</span>)<br>    .data(chapter_total_data)<br>    .enter().append(<span class="hljs-string">&quot;text&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;card-label&quot;</span>)<br>    .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;.35em&quot;</span>)<br>    .each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>        d.centerAngle = chapter_location_data[d.chapter-<span class="hljs-number">1</span>].centerAngle;<br>    &#125;)<br>    .attr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;rotate(&quot;</span> + (d.centerAngle * <span class="hljs-number">180</span> / <span class="hljs-built_in">Math</span>.PI - <span class="hljs-number">90</span>) + <span class="hljs-string">&quot;)&quot;</span><br>            + <span class="hljs-string">&quot;translate(&quot;</span> + rad_card_label + <span class="hljs-string">&quot;)&quot;</span><br>            + (d.centerAngle &gt; <span class="hljs-number">0</span> &amp; d.centerAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;rotate(180)&quot;</span>);<br>    &#125;)<br>    .style(<span class="hljs-string">&quot;text-anchor&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123; <span class="hljs-keyword">return</span> d.centerAngle &gt; <span class="hljs-number">0</span> &amp; d.centerAngle &lt; <span class="hljs-built_in">Math</span>.PI ? <span class="hljs-string">&quot;start&quot;</span> : <span class="hljs-string">&quot;end&quot;</span>; &#125;)<br>    .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">10</span> * size_factor) + <span class="hljs-string">&quot;px&quot;</span>)<br>    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d, i</span>) </span>&#123; <span class="hljs-keyword">return</span> d.card_captured; &#125;);<br></code></pre></td></tr></table></figure>

<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p><img src="20.png" srcset="/img/loading.gif" lazyload alt="image-20210810114145820"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br>  <span class="hljs-comment">///////////////// Create annotation gradients ////////////////</span><br>  <span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br><br>  <span class="hljs-comment">//Gradient for the titles of the annotations</span><br>  <span class="hljs-keyword">var</span> grad = defs.append(<span class="hljs-string">&quot;linearGradient&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;gradient-title&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;x1&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>).attr(<span class="hljs-string">&quot;y1&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;x2&quot;</span>, <span class="hljs-string">&quot;100%&quot;</span>).attr(<span class="hljs-string">&quot;y2&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>);<br>  grad.append(<span class="hljs-string">&quot;stop&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;offset&quot;</span>, <span class="hljs-string">&quot;50%&quot;</span>)   <br>      .attr(<span class="hljs-string">&quot;stop-color&quot;</span>, color_sakura);<br>  grad.append(<span class="hljs-string">&quot;stop&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;offset&quot;</span>, <span class="hljs-string">&quot;200%&quot;</span>)   <br>      .attr(<span class="hljs-string">&quot;stop-color&quot;</span>, <span class="hljs-string">&quot;#ED8B6A&quot;</span>);<br><br>  <span class="hljs-comment">//Gradient for the titles of the annotations</span><br>  <span class="hljs-keyword">var</span> grad = defs.append(<span class="hljs-string">&quot;linearGradient&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;gradient-title-legend&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;x1&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>).attr(<span class="hljs-string">&quot;y1&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;x2&quot;</span>, <span class="hljs-string">&quot;100%&quot;</span>).attr(<span class="hljs-string">&quot;y2&quot;</span>, <span class="hljs-string">&quot;0%&quot;</span>);<br>  grad.append(<span class="hljs-string">&quot;stop&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;offset&quot;</span>, <span class="hljs-string">&quot;50%&quot;</span>)   <br>      .attr(<span class="hljs-string">&quot;stop-color&quot;</span>, color_syaoran);<br>  grad.append(<span class="hljs-string">&quot;stop&quot;</span>)<br>      .attr(<span class="hljs-string">&quot;offset&quot;</span>, <span class="hljs-string">&quot;200%&quot;</span>)   <br>      .attr(<span class="hljs-string">&quot;stop-color&quot;</span>, <span class="hljs-string">&quot;#9ABF2B&quot;</span>);<br> <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br>  <span class="hljs-comment">///////////////////////////// Create annotations //////////////////////////</span><br>  <span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br><br>  <span class="hljs-comment">//Only create annotations when the screen is big enough</span><br>  <span class="hljs-keyword">if</span>(!width_too_small) &#123;<br><br>      <span class="hljs-keyword">var</span> annotations = [<br>          &#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Around the right half of the large circle you can see in which chapter the Clow cards were captured. Sakura was already in possession of Windy and Wood at the start of chapter 1&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Clow Cards&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">270</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">1</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">24</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-legend&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">151</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">705</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">55</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">686</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;These circles reveal the main colors present in each chapter&#x27;s cover art. The size of each circle represents the percentage of the cover image that is captured in that color. All circles from one chapter add up to 100%&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Cover art&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">270</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">1</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">55</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-legend&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">532</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">532</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">412</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">493</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;With the 10 captured cards, Kero teaches Sakura how to do a fortune-telling to get insight into which card is running around town looking like Sakura&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Fortune-telling&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">205</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">11</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">745</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">115</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">612</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">161</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Sakura, Tomoyo and Syaoran are stuck in a maze, when Kaho appears and breaks the walls with her &#x27;Moon Bell&#x27;, guiding the group to the exit&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Kaho&#x27;s Bell&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">190</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">15</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">22</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">774</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">240</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">657</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">170</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;This chapter is mostly Sakura and Syaoran during their school trip at the beach. While on an evening event in a cave everybody else starts to disappear&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Ghost stories&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">200</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">17</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">736</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">407</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">607</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">323</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Kero can finally return to his full form after Sakura catches the Firey card&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Cerberus&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">180</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">23</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: <span class="hljs-number">256</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">780</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: <span class="hljs-number">210</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">650</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;After the capture of all 19 cards, Yue holds &#x27;the final trial&#x27;. Eventually, he accepts Sakura as the new mistress of the Clow Cards&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;The final judge&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">220</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">26</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">60</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-right note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">10</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">812</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">26</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">634</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Around the left half of the large circle you can see in which chapter the Clow cards were converted to Sakura cards&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Sakura Cards&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">200</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">29</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">25</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-legend&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">291</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">764</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">287</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">624</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Syaoran finally understands that it&#x27;s Sakura that he loves, not Yukito&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;First love&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">170</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">31</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">92</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">460</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">655</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">406</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">485</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;The Fly transforms to give Sakura herself wings to fly, instead of her staff&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Fly&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">230</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">32</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">27</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">598</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">556</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">515</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">485</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Toya gives his magical powers to Yue (and thus also Yukito) to keep them from disappearing because Sakura doesn&#x27;t yet have enough magic herself to sustain them&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Toya&#x27;s gift&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">180</span>*size_factor,<br>                  <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>*size_factor<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">38</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">50</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">785</span> * size_factor,<br>              <span class="hljs-attr">y</span>: <span class="hljs-number">148</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">700</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: <span class="hljs-number">12</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Sakura and Syaoran use their magic together to defeat Eriol&#x27;s bronze horse&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;Teamwork&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">200</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">42</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">735</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">366</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">695</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">370</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Sakura &#x27;defeats&#x27; Eriol and has now transformed all the Clow cards into Sakura cards&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;The strongest magician&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">270</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">44</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">596</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">577</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">593</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">560</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;,&#123;<br>              <span class="hljs-attr">note</span>: &#123;<br>                  <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;Sakura realizes she loves Syaoran the most, right before he leaves for the airport to move back home to Hong Kong&quot;</span>,<br>                  <span class="hljs-attr">title</span>: <span class="hljs-string">&quot;True love&quot;</span>,<br>                  <span class="hljs-attr">wrap</span>: <span class="hljs-number">240</span>*size_factor,<br>              &#125;,<br>              <span class="hljs-attr">chapter</span>: <span class="hljs-number">50</span>,<br>              <span class="hljs-attr">extra_rad</span>: <span class="hljs-number">30</span> * size_factor,<br>              <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;note-left note-story&quot;</span>,<br>              <span class="hljs-attr">x</span>: -<span class="hljs-number">125</span> * size_factor,<br>              <span class="hljs-attr">y</span>: -<span class="hljs-number">660</span> * size_factor,<br>              <span class="hljs-attr">cx</span>: -<span class="hljs-number">48</span> * size_factor,<br>              <span class="hljs-attr">cy</span>: -<span class="hljs-number">633</span> * size_factor,<br>              <span class="hljs-attr">dx</span>: <span class="hljs-number">5</span> * size_factor,<br>              <span class="hljs-attr">dy</span>: -<span class="hljs-number">5</span> * size_factor<br>          &#125;<br>      ];<br><br>      <span class="hljs-comment">//Set-up the annotation maker</span><br>      <span class="hljs-keyword">var</span> makeAnnotations = d3.annotation()<br>          <span class="hljs-comment">//.editMode(true)</span><br>          .type(d3.annotationLabel)<br>          .annotations(annotations);<br><br>      <span class="hljs-comment">//Call and create the textual part of the annotations</span><br>      <span class="hljs-keyword">var</span> annotation_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;annotation-group&quot;</span>);<br>      annotation_group.call(makeAnnotations);<br>  <br>      <span class="hljs-comment">//Update a few stylings</span><br>      annotation_group.selectAll(<span class="hljs-string">&quot;.note-line, .connector&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>      annotation_group.selectAll(<span class="hljs-string">&quot;.annotation-note-title&quot;</span>)<br>          .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;url(#gradient-title)&quot;</span>);<br><br>      <span class="hljs-comment">//Create my own radially pointing connector lines</span><br>      <span class="hljs-keyword">var</span> annotation_connector_group = annotation_group.append(<span class="hljs-string">&quot;g&quot;</span>, <span class="hljs-string">&quot;annotation-connectors&quot;</span>);<br>      annotations.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">d,i</span>) </span>&#123;<br>          <span class="hljs-keyword">var</span> angle = <span class="hljs-built_in">Math</span>.atan(d.cy/d.cx);<br>          <span class="hljs-keyword">if</span>(d.cx &lt; <span class="hljs-number">0</span>) angle = -<span class="hljs-built_in">Math</span>.atan(d.cy/-d.cx) + <span class="hljs-built_in">Math</span>.PI;<br>          annotation_connector_group.append(<span class="hljs-string">&quot;line&quot;</span>)<br>              .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;connector-manual &quot;</span> + d.className)<br>              .attr(<span class="hljs-string">&quot;x1&quot;</span>, d.cx)<br>              .attr(<span class="hljs-string">&quot;y1&quot;</span>, d.cy)<br>              .attr(<span class="hljs-string">&quot;x2&quot;</span>, d.cx + d.extra_rad * <span class="hljs-built_in">Math</span>.cos(angle) )<br>              .attr(<span class="hljs-string">&quot;y2&quot;</span>, d.cy + d.extra_rad * <span class="hljs-built_in">Math</span>.sin(angle) )<br>              .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">2</span> * size_factor)<br>              .style(<span class="hljs-string">&quot;stroke-linecap&quot;</span>, <span class="hljs-string">&quot;round&quot;</span>)<br>              .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_sakura);<br>      &#125;);<br><br>      <span class="hljs-comment">//Turn the legend based annotations green</span><br>      annotation_group.selectAll(<span class="hljs-string">&quot;.note-legend .annotation-note-title&quot;</span>)<br>          .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;url(#gradient-title-legend)&quot;</span>);<br>      annotation_connector_group.selectAll(<span class="hljs-string">&quot;.note-legend&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_syaoran);<br><br>      <span class="hljs-comment">//Add circles to the legend annotations</span><br>      <span class="hljs-keyword">var</span> annotation_circle_group = annotation_group.append(<span class="hljs-string">&quot;g&quot;</span>, <span class="hljs-string">&quot;annotation-circles&quot;</span>);<br>      <span class="hljs-comment">//Add circle to first clow card                       </span><br>      annotation_circle_group.append(<span class="hljs-string">&quot;circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;annotation-circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;cx&quot;</span>, <span class="hljs-number">50</span> * size_factor)<br>          .attr(<span class="hljs-string">&quot;cy&quot;</span>, -<span class="hljs-number">655</span> * size_factor)<br>          .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-number">25</span> * size_factor);<br><br>      <span class="hljs-comment">//Add circle to cover art annotation</span><br>      annotation_circle_group.append(<span class="hljs-string">&quot;circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;annotation-circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;cx&quot;</span>, rad_color * <span class="hljs-built_in">Math</span>.cos(chapter_location_data[<span class="hljs-number">5</span>].centerAngle - pi1_2))<br>          .attr(<span class="hljs-string">&quot;cy&quot;</span>, rad_color * <span class="hljs-built_in">Math</span>.sin(chapter_location_data[<span class="hljs-number">5</span>].centerAngle - pi1_2))<br>          .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-number">38</span> * size_factor);<br>      <br>      <span class="hljs-comment">//Add circle to first sakura card                       </span><br>      annotation_circle_group.append(<span class="hljs-string">&quot;circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;annotation-circle&quot;</span>)<br>          .attr(<span class="hljs-string">&quot;cx&quot;</span>, -<span class="hljs-number">273</span> * size_factor)<br>          .attr(<span class="hljs-string">&quot;cy&quot;</span>, <span class="hljs-number">596</span> * size_factor)<br>          .attr(<span class="hljs-string">&quot;r&quot;</span>, <span class="hljs-number">25</span> * size_factor);<br><br>      annotation_circle_group.selectAll(<span class="hljs-string">&quot;.annotation-circle&quot;</span>)<br>          .style(<span class="hljs-string">&quot;stroke-dasharray&quot;</span>, <span class="hljs-string">&quot;0,&quot;</span> + (<span class="hljs-number">6</span> * size_factor))<br>          .style(<span class="hljs-string">&quot;stroke-width&quot;</span>, <span class="hljs-number">2.5</span> * size_factor)<br>          .style(<span class="hljs-string">&quot;stroke&quot;</span>, color_syaoran);<br><br>      <span class="hljs-comment">//Make it possible to show/hide the annotations</span><br>      <span class="hljs-keyword">var</span> show_annotations = <span class="hljs-literal">true</span>;<br>      d3.select(<span class="hljs-string">&quot;#story-annotation&quot;</span>)<br>          .style(<span class="hljs-string">&quot;opacity&quot;</span>, <span class="hljs-number">1</span>)<br>          .on(<span class="hljs-string">&quot;click&quot;</span>, spoiler_click);<br><br>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">spoiler_click</span>(<span class="hljs-params"></span>) </span>&#123;<br>          show_annotations = !show_annotations;<br>          annotation_group.selectAll(<span class="hljs-string">&quot;.note-story&quot;</span>)<br>              .style(<span class="hljs-string">&quot;opacity&quot;</span>, show_annotations ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>          d3.select(<span class="hljs-string">&quot;#hide-show&quot;</span>).html(show_annotations ? <span class="hljs-string">&quot;hide&quot;</span> : <span class="hljs-string">&quot;show&quot;</span>);<br>      &#125;<span class="hljs-comment">//function spoiler_click</span><br><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//Hide the annotation mentions in the intro</span><br>      d3.select(<span class="hljs-string">&quot;#annotation-explanation&quot;</span>).style(<span class="hljs-string">&quot;display&quot;</span>,<span class="hljs-string">&quot;none&quot;</span>);<br>  &#125;<span class="hljs-comment">//else</span><br></code></pre></td></tr></table></figure>

<p><img src="21.png" srcset="/img/loading.gif" lazyload alt="image-20210810114503061"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">///////////////////////////////////////////////////////////////////////////</span><br> <span class="hljs-comment">///////////////////////// Create line title label /////////////////////////</span><br> <span class="hljs-comment">/////////////////////////////////////////////////////////////////////////// </span><br><br> <span class="hljs-keyword">var</span> line_label_group = chart.append(<span class="hljs-string">&quot;g&quot;</span>).attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;line-label-group&quot;</span>);<br><br> <span class="hljs-comment">//Define the arc on which to draw the label text</span><br> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">label_arc</span>(<span class="hljs-params">angle</span>) </span>&#123;<br>     <span class="hljs-keyword">var</span> x1 = rad_line_label * <span class="hljs-built_in">Math</span>.cos(angle + <span class="hljs-number">0.01</span> - pi1_2),<br>         y1 = rad_line_label * <span class="hljs-built_in">Math</span>.sin(angle + <span class="hljs-number">0.01</span> - pi1_2);<br>     <span class="hljs-keyword">var</span> x2 = rad_line_label * <span class="hljs-built_in">Math</span>.cos(angle - <span class="hljs-number">0.01</span> - pi1_2),<br>         y2 = rad_line_label * <span class="hljs-built_in">Math</span>.sin(angle - <span class="hljs-number">0.01</span> - pi1_2);<br>     <span class="hljs-keyword">if</span> (angle / <span class="hljs-built_in">Math</span>.PI &gt; <span class="hljs-number">0.5</span> &amp;&amp; angle / <span class="hljs-built_in">Math</span>.PI &lt; <span class="hljs-number">1.5</span>) &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;M&quot;</span> + x1 + <span class="hljs-string">&quot;,&quot;</span> + y1 + <span class="hljs-string">&quot; A&quot;</span> + rad_line_label + <span class="hljs-string">&quot;,&quot;</span> + rad_line_label + <span class="hljs-string">&quot; 0 1 1 &quot;</span> + x2 + <span class="hljs-string">&quot;,&quot;</span> + y2;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;M&quot;</span> + x2 + <span class="hljs-string">&quot;,&quot;</span> + y2 + <span class="hljs-string">&quot; A&quot;</span> + rad_line_label + <span class="hljs-string">&quot;,&quot;</span> + rad_line_label + <span class="hljs-string">&quot; 0 1 0 &quot;</span> + x1 + <span class="hljs-string">&quot;,&quot;</span> + y1;<br>     &#125;<span class="hljs-comment">//else</span><br> &#125;<span class="hljs-comment">//function label_arc</span><br><br> <span class="hljs-comment">//Create the paths along which the pillar labels will run</span><br> <span class="hljs-keyword">var</span> line_label_path = line_label_group.append(<span class="hljs-string">&quot;path&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;line-label-path&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;line-label-path&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;d&quot;</span>, label_arc(characterByName[<span class="hljs-string">&quot;Sakura&quot;</span>].name_angle))<br>     .style(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>)<br>     .style(<span class="hljs-string">&quot;display&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br><br> <span class="hljs-comment">//Create the label text</span><br> <span class="hljs-keyword">var</span> default_label_text = <span class="hljs-string">&quot;currently, these lines show which characters appear on the chapter&#x27;s cover art&quot;</span>;<br> <span class="hljs-keyword">var</span> line_label = line_label_group.append(<span class="hljs-string">&quot;text&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;line-label&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;dy&quot;</span>, <span class="hljs-string">&quot;0.35em&quot;</span>)<br>     .style(<span class="hljs-string">&quot;text-anchor&quot;</span>, <span class="hljs-string">&quot;middle&quot;</span>)<br>     .style(<span class="hljs-string">&quot;font-size&quot;</span>, (<span class="hljs-number">14</span> * size_factor) + <span class="hljs-string">&quot;px&quot;</span>)<br>     .append(<span class="hljs-string">&quot;textPath&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;xlink:href&quot;</span>, <span class="hljs-string">&quot;#line-label-path&quot;</span>)<br>     .attr(<span class="hljs-string">&quot;startOffset&quot;</span>, <span class="hljs-string">&quot;50%&quot;</span>)<br>     .text(default_label_text);<br></code></pre></td></tr></table></figure>

<h3 id="帮助函数"><a href="#帮助函数" class="headerlink" title="帮助函数"></a>帮助函数</h3><p>使用到的一些帮助函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">////////////////////// 帮助函数  //////////////////////</span><br><span class="hljs-comment">//////////////////////////////////////////////////////////////</span><br><br><span class="hljs-comment">// RGB 到 CMYK颜色转换 &quot;circle radii&quot;</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rgbToCMYK</span>(<span class="hljs-params">rgb</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> r = rgb.r / <span class="hljs-number">255</span>,<br>        g = rgb.g / <span class="hljs-number">255</span>,<br>        b = rgb.b / <span class="hljs-number">255</span>,<br>        k = <span class="hljs-number">1</span> - <span class="hljs-built_in">Math</span>.max(r, g, b);<br><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">cyan</span>: (<span class="hljs-number">1</span> - r - k) / (<span class="hljs-number">1</span> - k),<br>        <span class="hljs-attr">magenta</span>: (<span class="hljs-number">1</span> - g - k) / (<span class="hljs-number">1</span> - k),<br>        <span class="hljs-attr">yellow</span>: (<span class="hljs-number">1</span> - b - k) / (<span class="hljs-number">1</span> - k),<br>        <span class="hljs-attr">black</span>: k<br>    &#125;;<br>&#125;<span class="hljs-comment">//function rgbToCMYK</span><br><span class="hljs-comment">//生成随机数</span><br><span class="hljs-keyword">var</span> seed = <span class="hljs-number">4</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">random</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> x = <span class="hljs-built_in">Math</span>.sin(seed++) * <span class="hljs-number">10000</span>;<br>    <span class="hljs-keyword">return</span> x - <span class="hljs-built_in">Math</span>.floor(x);<br>&#125;<span class="hljs-comment">//function random</span><br><span class="hljs-comment">//首字母大写函数</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">capitalizeFirstLetter</span>(<span class="hljs-params">string</span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> string.charAt(<span class="hljs-number">0</span>).toUpperCase() + string.slice(<span class="hljs-number">1</span>);<br>&#125;<span class="hljs-comment">//function capitalizeFirstLetter</span><br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/D3/">D3</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/13/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E7%82%B9/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">计算机网络知识点</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/09/%E7%99%BE%E5%8F%98%E5%B0%8F%E6%A8%B1%E4%B8%80%E2%80%94%E2%80%94%E7%9B%B8%E5%85%B3API%E4%BB%8B%E7%BB%8D/">
                        <span class="hidden-mobile">百变小樱一——相关API介绍</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div>李煜</div> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
